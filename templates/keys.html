<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Keys | Admin</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">Admin Panel</div>
        <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Close Sidebar" title="Close Sidebar">âœ•</button>
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="/dashboard" class="nav-link">
            <span>ðŸ“Š</span> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="/generate" class="nav-link">
            <span>ðŸ”‘</span> Generate Key
          </a>
        </li>
        <li class="nav-item">
          <a href="/keys" class="nav-link active">
            <span>ðŸ“‹</span> All Keys
          </a>
        </li>
        <li class="nav-item">
          <a href="/stats" class="nav-link">
            <span>ðŸ“ˆ</span> Statistics
          </a>
        </li>
      </ul>
      <div style="margin-top: auto;">
        <a href="/logout" class="nav-link">
          <span>ðŸšª</span> Logout
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle Menu" title="Toggle Menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="page-title">
          <h2>All Keys</h2>
          <p>Manage generated keys</p>
        </div>
        <div class="actions">
          <button class="btn btn-icon" onclick="toggleTheme()" title="Toggle Theme">
            <span id="themeIcon">ðŸŒ™</span>
          </button>
        </div>
      </header>

      <div class="table-card">
        <div class="table-header-row">
          <div class="chart-title">Key History</div>
        </div>

        <div style="overflow-x: auto;">
          {% if generated_keys %}
          <table id="keys-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Key</th>
                <th>Status</th>
                <th>Duration (Days)</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for key in generated_keys %}
              <tr data-id="{{ key.id }}">
                <td style="color: var(--text-secondary);">{{ loop.index }}</td>
                <td><span class="key-code">{{ key.key }}</span></td>
                <td>
                  <span class="status-pill {{ 'status-pro' if key.status == 'Used' else 'status-free' }}">
                    {{ key.status }}
                  </span>
                </td>
                <td>{{ key.duration_days }}</td>
                <td style="color: var(--text-secondary);">{{ key.created_at[:10] if key.created_at else 'N/A' }}</td>
                <td>
                  {% if key.status == 'Unused' %}
                  <button class="action-btn" onclick="deleteKey('{{ key.id }}')" title="Delete Key">
                    âœ•
                  </button>
                  {% else %}
                  <button class="action-btn" disabled style="opacity: 0.3; cursor: not-allowed;"
                    title="Cannot delete used keys">
                    âœ•
                  </button>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
            No keys generated yet.
          </div>
          {% endif %}
        </div>
      </div>
    </main>
  </div>

  <script>
    // Theme Management
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      document.getElementById('themeIcon').textContent = newTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
    }

    // Load saved theme
    (function () {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
    })();

    // Sidebar Toggle
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        if (window.innerWidth > 768) {
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      }
    }

    // Load sidebar state
    (function () {
      const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      if (isCollapsed) {
        document.getElementById('sidebar').classList.add('collapsed');
      }
      // Auto-close sidebar on mobile when any nav link is clicked
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('collapsed');
          }
        });
      });
    })();

    async function deleteKey(keyId) {
      if (!confirm('Are you sure you want to delete this key?')) return;

      try {
        const response = await fetch(`/delete_key/${keyId}`, { method: 'DELETE' });
        const data = await response.json();

        if (response.ok) {
          const row = document.querySelector(`tr[data-id="${keyId}"]`);
          if (row) row.remove();
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while deleting the key.');
      }
    }
  </script>
</body>

</html>